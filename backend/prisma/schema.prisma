generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
    ADMIN
    DOCTOR
    CLINIC
}

enum AuthProvider {
  GOOGLE
  FACEBOOK
  EMAIL
}

enum DoctorSpecialization {
  GENERAL_PHYSICIAN
  CARDIOLOGIST
  DERMATOLOGIST
  ENDOCRINOLOGIST
  GYNECOLOGIST
  NEUROSURGEON
  ORTHOPEDIC_SURGEON
  PLASTIC_SURGEON
  UROLOGIST
  ENT_SPECIALIST
  PEDIATRICIAN
  PSYCHIATRIST
  DENTIST
}

model Document {
  id        String   @id @default(uuid())
  docUrl    String
  name      String
  type      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  doctorId    String?
  doctor      Doctor?     @relation("DoctorDocuments", fields: [doctorId], references: [id])
  clinicId    String?
  clinic      Clinic?     @relation("ClinicDocuments", fields: [clinicId], references: [id])

  profileImageOf Doctor? @relation("UserProfileImage")
  clinicProfileImageOf Clinic? @relation("ClinicProfileImage")
  patientProfileImageOf Patient? @relation("PatientProfileImage")
}

model Doctor {
  id String @id @default(uuid())
  email   String @unique
  isVerified   Boolean    @default(false)
  fullName String
  gender String
  dateOfBirth DateTime
  phoneNumber String
  address String
  latitude    Float?
  longitude   Float?
  preferredRadius Int?
  locationRange Int
  specialization DoctorSpecialization @default(GENERAL_PHYSICIAN)
  additionalInformation String?
  experience Int
  about String
  certifications String[]
  profileImageId String? @unique
  profileImage   Document? @relation("UserProfileImage", fields: [profileImageId], references: [id])
  documents      Document[] @relation("DoctorDocuments")
  pitches        Pitch[]
  accepted       AcceptedWork[]
  newsComments NewsComment[]
  newsLikes    NewsLike[]
  chats ChatParticipant[]
  payments      Payment[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages Message[] @relation("MessageSenderDoctor")
  patients Patient[]
  @@index([email])
  @@index([specialization])
  @@index([latitude, longitude])
  @@index([isVerified])
  @@index([createdAt])
}

model Clinic {
  id String @id @default(uuid())
  email   String @unique
  isVerified   Boolean    @default(false)
  ownerName String
  ownerPhoneNumber String
  clinicName String
  clinicAddress String
  latitude    Float?
  longitude   Float?
  preferredRadius Int?
  clinicPhoneNumber String
  clinicAdditionalDetails String?
  clinicProfileImageId String? @unique
  clinicProfileImage   Document? @relation("ClinicProfileImage", fields: [clinicProfileImageId], references: [id])
  documents      Document[] @relation("ClinicDocuments")
  jobRequirements JobRequirement[]
  accepted       AcceptedWork[]   
  newsComments NewsComment[]
  newsLikes    NewsLike[]
  galleryImages ClinicGalleryImage[]
  chats ChatParticipant[]
  patients Patient[]
  payments      Payment[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages Message[] @relation("MessageSenderClinic")
  
  @@index([email])
  @@index([latitude, longitude])
  @@index([isVerified])
  @@index([createdAt])
  @@index([clinicName])
}

model Patient {
  id String @id @default(uuid())
  name String
  phoneNumber String
  gender String
  dateOfBirth DateTime
  profileImageId String? @unique
  profileImage   Document? @relation("PatientProfileImage", fields: [profileImageId], references: [id])
  address String
  latitude Float?
  longitude Float?

  clinicId String
  clinic Clinic @relation(fields: [clinicId], references: [id])

  status PatientStatus @default(ACTIVE)
  feedbacks Feedback[]

  assignedDoctors   Doctor[]
  chats Chat[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clinicId])
  @@index([status])
  @@index([createdAt])
  @@index([phoneNumber])
  @@index([latitude, longitude])
}

model Feedback {
  id String @id @default(uuid())
  feedback String
  patientId String
  patient Patient @relation(fields: [patientId], references: [id])
  createdAt DateTime @default(now())
}

enum PatientStatus {
  ACTIVE
  COMPLETED
}

model Admin {
  id String @id @default(uuid())
  email   String @unique
  isVerified   Boolean    @default(false)
  news News[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum RequirementType {
    ONETIME
    FULLTIME
    PARTTIME
}

enum RequirementStatus {
    POSTED
    COMPLETED
}

model JobRequirement {
  id          String     @id @default(uuid())
  title       String
  description String
  location    String
  specialization DoctorSpecialization?
  additionalInformation String?
  date        DateTime?
  type        RequirementType
  requirementStatus     RequirementStatus
  clinicId    String
  clinic      Clinic     @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  pitches     Pitch[]
  accepted    AcceptedWork?

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  @@index([clinicId])
  @@index([specialization])
  @@index([type])
  @@index([requirementStatus])
  @@index([createdAt])
  @@index([clinicId, requirementStatus])
}


model Pitch {
  id               String     @id @default(uuid())
  doctorId         String
  doctor           Doctor     @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  jobRequirementId String
  jobRequirement   JobRequirement @relation(fields: [jobRequirementId], references: [id], onDelete: Cascade)

  message          String?
  status           PitchStatus    @default(PENDING)

  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  
  @@index([doctorId])
  @@index([jobRequirementId])
  @@index([status])
  @@index([createdAt])
  @@index([doctorId, status])
  @@index([jobRequirementId, status])
}

enum PitchStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
}

model AcceptedWork {
  id             String     @id @default(uuid())

  doctorId       String
  doctor         Doctor     @relation(fields: [doctorId], references: [id])

  clinicId       String
  clinic         Clinic     @relation(fields: [clinicId], references: [id])

  jobId          String @unique
  job            JobRequirement @relation(fields: [jobId], references: [id])

  connectedAt    DateTime   @default(now())
}


model Payment {
  id             String     @id @default(uuid())

  doctorId       String
  doctor         Doctor     @relation(fields: [doctorId], references: [id])
  clinicId       String
  clinic         Clinic     @relation(fields: [clinicId], references: [id])

  amount         Float
  currency       String     @default("INR")
  status         PaymentStatus
  provider       String     // Razorpay, etc.
  referenceId    String     @unique
  purpose        String     // Onboarding fee, etc.

  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}

enum PaymentStatus {
  SUCCESS
  FAILED
  PENDING
}


model News {
  id          String        @id @default(uuid())
  title       String
  content     String
  imageUrl    String?

  postedById  String
  postedBy    Admin         @relation(fields: [postedById], references: [id])

  comments    NewsComment[]
  likes       NewsLike[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}



model NewsComment {
  id        String   @id @default(uuid())
  content   String

  newsId    String
  news      News     @relation(fields: [newsId], references: [id])

  doctorId  String?     // ⬅️ Make optional
  doctor    Doctor?     @relation(fields: [doctorId], references: [id])

  clinicId  String?     // ⬅️ Make optional
  clinic    Clinic?     @relation(fields: [clinicId], references: [id])

  parentId  String?      
  parent    NewsComment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies   NewsComment[] @relation("CommentReplies")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model NewsLike {
  id        String   @id @default(uuid())

  newsId    String
  news      News     @relation(fields: [newsId], references: [id])

  doctorId  String?     // ⬅️ Make optional
  doctor    Doctor?     @relation(fields: [doctorId], references: [id])

  clinicId  String?     // ⬅️ Make optional
  clinic    Clinic?     @relation(fields: [clinicId], references: [id])

  createdAt DateTime @default(now())
}


model OnboardingFee {
  id String @id @default(uuid())
  fee Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Chat {
  id String @id @default(uuid())
  
  // Link chat to a specific patient
  patientId String
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  messages Message[]
  participants ChatParticipant[]
  lastMessageAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId])
  @@index([lastMessageAt])
}

model ChatParticipant{
  id String @id @default(uuid())
  doctorId String?
  doctor Doctor? @relation(fields: [doctorId], references: [id])
  clinicId String?
  clinic Clinic? @relation(fields: [clinicId], references: [id])
  chatId String
  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  joinedAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([chatId])
  @@index([doctorId])
  @@index([clinicId])
  @@unique([chatId, doctorId])
  @@unique([chatId, clinicId])
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

model Message {
  id String @id @default(uuid())
  content String
  
  // Only one sender per message
  senderDoctorId String?
  senderDoctor Doctor? @relation("MessageSenderDoctor", fields: [senderDoctorId], references: [id])
  senderClinicId String?
  senderClinic Clinic? @relation("MessageSenderClinic", fields: [senderClinicId], references: [id])
  
  chatId String
  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  
  // Message status and read tracking
  status MessageStatus @default(SENT)
  readAt DateTime?
  
  // Attachment support
  attachments MessageAttachment[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([chatId])
  @@index([createdAt])
  @@index([senderDoctorId])
  @@index([senderClinicId])
  @@index([status])
}

model MessageAttachment {
  id String @id @default(uuid())
  messageId String
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  filename String
  url String
  type String // 'image', 'video', 'audio', 'document', 'other'
  size Int? // File size in bytes
  
  createdAt DateTime @default(now())

  @@index([messageId])
}

model ClinicGalleryImage {
  id          String   @id @default(uuid())
  imageUrl    String
  caption     String?
  isActive    Boolean  @default(true)
  
  clinicId    String
  clinic      Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}